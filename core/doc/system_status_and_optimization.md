# A股股票推荐系统 - 项目总结与优化建议

**日期:** 2025-12-13
**状态:** 原型完成 (Prototype Complete)

## 1. 系统概览 (Current Status)

本系统基于 `vnpy.alpha` 框架构建，旨在通过机器学习模型预测A股走势并生成交易推荐。目前已完成核心的数据链路、模型训练和回测验证闭环。

### 1.1 核心模块
*   **数据获取 (`core/data_download`):** 支持从 Tushare 和 XtQuant 下载A股日线历史数据，并进行了初步的流动性筛选（上市时间 > 3年，日均成交额 > 1亿）。
*   **数据清洗与入库 (`core/recommendation_system/ingest_data.py`):** 将下载的 Bar 数据导入 `vnpy.alpha` 的 Parquet 数据库，并修正了合约乘数（Size=1）以适配股票交易逻辑。
*   **特征工程 (`core/recommendation_system/features.py`):** 构建了基于动量 (ROC, MA Trend)、波动率 (ATR, Std Dev)、成交量 (Vol ROC) 和摆动指标 (RSI) 的 Alpha 因子集。
*   **模型训练 (`core/recommendation_system/run_backtest.py`):** 使用 MLP (多层感知机) 模型，基于 RobustZScore 归一化处理的数据进行训练。预测目标为未来5日的收益率。
*   **交易策略 (`core/recommendation_system/strategy.py`):** `RecStrategy` 选取模型预测得分最高的 Top-K 只股票进行等权持仓。包含 10% 止损和 3 天最小持仓期逻辑。

### 1.2 关键修复
在开发过程中，修复了导致回测爆仓的两个关键缺陷：
1.  **合约乘数错误:** 修正了入库时 `size=100` 为 `size=1`，避免了计算持仓市值时的 100 倍杠杆放大。
2.  **持仓同步失败:** 在策略 `on_trade` 中补充了 `super().on_trade(trade)` 调用，确保策略引擎正确更新底层持仓数据，防止了重复买入导致的资金耗尽。

## 2. 回测表现 (Backtest Performance)

基于 2024-07-01 至 2025-12-12 的测试集数据：

*   **总收益率:** ~66.73%
*   **年化收益:** ~45.12%
*   **夏普比率 (Sharpe):** 0.89
*   **最大回撤:** ~28.76%
*   **胜率 (Win Rate):** ~51.7% (盈利交易日/总交易日)

**评价:** 策略展现了较强的捕捉趋势能力，收益显著跑赢大盘（假设基准）。但 28% 的最大回撤表明风险依然较高，且夏普比率 0.89 意味着为了获得收益承担了较大的波动风险。

## 3. 优化建议 (Optimization Strategy)

为了提升系统的稳健性和实战价值，建议从以下几个维度进行优化：

### 3.1 风险管理 (Risk Management)
*   **动态仓位管理:** 目前采用固定资本等权分配。建议引入**波动率目标 (Volatility Targeting)** 或 **凯利公式**，降低高波动个股的仓位权重。
*   **大盘择时 (Market Timing):** 增加一个市场状态过滤器（如大盘均线、市场情绪指数）。当大盘处于明显下行趋势时，降低整体仓位或空仓，以减少系统性风险带来的回撤。
*   **跟踪止损 (Trailing Stop):** 将固定 10% 止损改为移动止损，在利润增加时以此保护收益，防止大幅回撤。

### 3.2 特征工程 (Feature Engineering)
*   **引入基本面因子:** 目前仅使用了量价因子。建议加入 **PE (市盈率)**, **PB (市净率)**, **ROE** 等财务指标，筛选低估值优质股，过滤纯情绪炒作的垃圾股。
*   **市场情绪因子:** 加入北向资金流向、融资融券余额变化等宏观资金面数据。
*   **因子正交化:** 对现有因子进行相关性分析，剔除高相关性的冗余因子，或使用 PCA 降维，提高模型训练效率。

### 3.3 模型迭代 (Model Improvement)
*   **时序模型:** 目前的 MLP 模型未充分利用时间序列特性。建议尝试 **LSTM**, **GRU** 或 **Transformer** 架构，以捕捉更长周期的市场模式。
*   **集成学习:** 训练多个不同架构或不同随机种子的模型，取预测结果的平均值（Ensemble），通常能显著降低预测方差，提高稳定性。
*   **滚动训练 (Walk-forward Analysis):** 定期（如每季度）重新训练模型，使其适应最新的市场风格变化。

### 3.4 组合构建 (Portfolio Construction)
*   **均值-方差优化:** 使用 Markowitz 投资组合理论，根据预测收益和协方差矩阵计算最优权重，而非简单的 Top-K 等权。
*   **行业中性化:** 确保持仓分散在不同行业，避免因单一行业（如新能源、半导体）回调导致净值大幅波动。

### 3.5 执行层面 (Execution)
*   **算法交易:** 在实盘中引入 TWAP/VWAP 算法拆单，减少大额冲击成本。
*   **交易成本精细化:** 回测中应更精细地模拟印花税、滑点和不同券商的佣金费率，确保回测结果更贴近真实。

## 4. 下一步计划
1.  **实现动态风控:** 在 `strategy.py` 中增加基于 ATR 的动态止损逻辑。
2.  **扩展数据源:** 尝试接入 Tushare 的财务数据接口。
3.  **模型对比:** 搭建一个 LSTM 模型版本进行对比测试。
