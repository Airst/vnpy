<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VNPY Recommendation System</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <style>
        .card { margin-bottom: 20px; }
        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.8); z-index: 9999;
            display: none; align-items: center; justify-content: center;
        }
    </style>
</head>
<body class="bg-light">

<!-- Loading Overlay -->
<div id="loadingOverlay">
    <div class="text-center">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
        <h4 class="mt-3">Processing... Please wait</h4>
    </div>
</div>

<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
        <a class="navbar-brand" href="#">VNPY RecSys</a>
    </div>
</nav>

<div class="container mt-4">
    <div class="row">
        <!-- Control Panel -->
        <div class="col-md-3">
            <div class="card shadow-sm">
                <div class="card-header bg-white fw-bold">Controls</div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Configuration</label>
                        <select id="configSelect" class="form-select">
                            {% for config in configs %}
                            <option value="{{ config }}">{{ config }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button class="btn btn-warning" onclick="updateData()">
                            Update Data
                        </button>
                        <hr>
                        <button class="btn btn-primary" onclick="runBacktest()">
                            Run Backtest
                        </button>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="forceReload">
                            <label class="form-check-label" for="forceReload">Force Reload Cache</label>
                        </div>
                        <hr>
                        <button class="btn btn-success" onclick="runPrediction()">
                            Run Prediction
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Stats Panel -->
            <div class="card shadow-sm" id="statsCard" style="display:none;">
                <div class="card-header bg-white fw-bold">Statistics</div>
                <div class="card-body small">
                    <ul class="list-group list-group-flush" id="statsList">
                    </ul>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-md-9">
            <!-- Prediction Results -->
            <div class="card shadow-sm" id="predictionCard" style="display:none;">
                <div class="card-header bg-success text-white">Prediction Results</div>
                <div class="card-body">
                    <h5 id="predictionDate" class="card-title"></h5>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="predictionTable">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Signal Score</th>
                                    <th>Close Price</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Backtest Charts -->
            <div class="card shadow-sm" id="chartCard" style="display:none;">
                <div class="card-header bg-white">
                    <ul class="nav nav-tabs card-header-tabs" id="chartTabs" role="tablist">
                        <li class="nav-item">
                            <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">Overview</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" id="pnl-tab" data-bs-toggle="tab" data-bs-target="#pnl" type="button" role="tab">PnL Analysis</button>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="chartTabContent">
                        <div class="tab-pane fade show active" id="overview" role="tabpanel">
                            <div id="balanceChart" style="height: 400px;"></div>
                            <div id="drawdownChart" style="height: 300px;"></div>
                        </div>
                        <div class="tab-pane fade" id="pnl" role="tabpanel">
                            <div id="dailyPnlChart" style="height: 400px;"></div>
                            <div id="pnlDistChart" style="height: 400px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS (bundle includes Popper) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const API_BASE = "/api";

    function showLoading() { document.getElementById('loadingOverlay').style.display = 'flex'; }
    function hideLoading() { document.getElementById('loadingOverlay').style.display = 'none'; }

    async function updateData() {
        showLoading();
        try {
            const res = await fetch(`${API_BASE}/update_data`, { method: 'POST' });
            const data = await res.json();
            alert(data.message);
        } catch (e) {
            alert("Error: " + e);
        } finally {
            hideLoading();
        }
    }

    async function runBacktest() {
        const config = document.getElementById('configSelect').value;
        const force = document.getElementById('forceReload').checked;
        
        showLoading();
        try {
            const res = await fetch(`${API_BASE}/run_backtest`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ config: config, force: force })
            });
            const data = await res.json();
            
            if (data.status === 'success') {
                renderCharts(data.daily_data);
                renderStats(data.stats);
                document.getElementById('chartCard').style.display = 'block';
                document.getElementById('statsCard').style.display = 'block';
            } else {
                alert("Error: " + data.message);
            }
        } catch (e) {
            console.error(e);
            alert("Request Failed: " + e.message);
        } finally {
            hideLoading();
        }
    }

    async function runPrediction() {
        const config = document.getElementById('configSelect').value;
        
        showLoading();
        try {
            const res = await fetch(`${API_BASE}/run_prediction`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ config: config })
            });
            const data = await res.json();
            
            if (data.status === 'success') {
                renderPredictionTable(data.data);
                document.getElementById('predictionCard').style.display = 'block';
            } else if (data.status === 'warning') {
                alert("Warning: " + data.message);
            } else {
                alert("Error: " + data.message);
            }
        } catch (e) {
            console.error(e);
            alert("Request Failed: " + e.message);
        } finally {
            hideLoading();
        }
    }

    function renderCharts(dailyData) {
        const dates = dailyData.map(d => d.date);
        const balance = dailyData.map(d => d.balance);
        const drawdown = dailyData.map(d => d.drawdown);
        const netPnl = dailyData.map(d => d.net_pnl);
        
        // --- Overview Tab ---
        // Balance Chart
        Plotly.newPlot('balanceChart', [{
            x: dates,
            y: balance,
            type: 'scatter',
            mode: 'lines',
            name: 'Balance',
            line: {color: '#0d6efd', width: 2}
        }], {
            title: 'Account Balance Curve',
            margin: { t: 40, r: 20, l: 60, b: 40 },
            hovermode: 'x unified'
        });

        // Drawdown Chart
        Plotly.newPlot('drawdownChart', [{
            x: dates,
            y: drawdown,
            type: 'scatter',
            fill: 'tozeroy',
            name: 'Drawdown',
            line: {color: '#dc3545', width: 1}
        }], {
            title: 'Drawdown Curve',
            margin: { t: 40, r: 20, l: 60, b: 40 },
            hovermode: 'x unified'
        });
        
        // --- PnL Analysis Tab ---
        // Daily PnL Bar Chart
        const colors = netPnl.map(v => v >= 0 ? '#198754' : '#dc3545');
        Plotly.newPlot('dailyPnlChart', [{
            x: dates,
            y: netPnl,
            type: 'bar',
            name: 'Daily PnL',
            marker: {color: colors}
        }], {
            title: 'Daily Profit & Loss',
            margin: { t: 40, r: 20, l: 60, b: 40 }
        });

        // PnL Distribution Histogram
        Plotly.newPlot('pnlDistChart', [{
            x: netPnl,
            type: 'histogram',
            name: 'PnL Dist',
            marker: {color: '#6c757d'},
            opacity: 0.75
        }], {
            title: 'Daily PnL Distribution',
            margin: { t: 40, r: 20, l: 60, b: 40 },
            xaxis: {title: 'PnL Amount'},
            yaxis: {title: 'Frequency'}
        });
    }

    function renderStats(stats) {
        const list = document.getElementById('statsList');
        list.innerHTML = '';
        
        const keys = [
            ['Total Return', 'total_return', '%'],
            ['Annual Return', 'annual_return', '%'],
            ['Sharpe Ratio', 'sharpe_ratio', ''],
            ['Max Drawdown', 'max_ddpercent', '%'],
            ['Total Trades', 'total_trade_count', ''],
            ['Win Rate', null, '%'], // Derived
            ['Profit Days', 'profit_days', ''],
            ['Loss Days', 'loss_days', '']
        ];
        
        // Calculate Win Rate if not present
        if (stats.total_trade_count > 0 && stats.profit_days !== undefined) {
             // Note: profit_days is usually days with +PnL, not trade win rate. 
             // But for daily strategy, it's close enough. 
             // Or we can use the 'trades' data if passed to calculate real trade win rate.
             // For now let's use Profit Days / Total Days? Or just skip derived.
             // Let's stick to simple stats.
        }
        
        keys.forEach(([label, key, suffix]) => {
            if (key === null) return; // Skip derived for now
            
            let val = stats[key];
            if (val === undefined) return;
            
            if (typeof val === 'number') val = val.toFixed(2);
            list.innerHTML += `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    ${label}
                    <span class="badge bg-primary rounded-pill">${val}${suffix}</span>
                </li>
            `;
        });
    }

    function renderPredictionTable(data) {
        const tbody = document.querySelector('#predictionTable tbody');
        tbody.innerHTML = '';
        
        if (data.length > 0) {
            document.getElementById('predictionDate').innerText = `Latest Data: ${data[0].datetime}`;
        }
        
        data.forEach(row => {
            const score = row.signal.toFixed(4);
            const color = row.signal > 0 ? 'text-success fw-bold' : 'text-danger';
            
            tbody.innerHTML += `
                <tr>
                    <td>${row.vt_symbol}</td>
                    <td class="${color}">${score}</td>
                    <td>${row.close ? row.close.toFixed(2) : 'N/A'}</td>
                    <td>${row.datetime}</td>
                </tr>
            `;
        });
    }
</script>
</body>
</html>